<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create User Account - KSITM CTE Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <link rel="stylesheet" href="css/style.css">
<style>
    /* Admin Signup Page Specific Styles */
    .main {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        width: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        flex: 1;
    }
    
    .a-header {
        background: rgba(255, 255, 255, 0.95);
        color: var(--dark);
        padding: 20px 0;
        box-shadow: var(--shadow);
        position: sticky;
        top: 0;
        z-index: 1000;
        backdrop-filter: blur(10px);
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
    }

    .logo {
        display: flex;
        align-items: center;
        gap: 15px;
        font-size: 1.6rem;
        font-weight: bold;
        text-decoration: none;
        color: var(--primary);
    }

    .logo-img {
        height: 60px;
        width: 60px;
        border-radius: 50%;
        border: 3px solid var(--primary);
        object-fit: cover;
    }

    .logo-text {
        display: flex;
        flex-direction: column;
    }

    .logo-title {
        font-size: 1.6rem;
        font-weight: 700;
    }

    .logo-subtitle {
        font-size: 0.9rem;
        color: var(--gray);
        font-weight: 400;
    }

    .user-info {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .page-title {
        margin: 30px 0;
        color: white;
        display: flex;
        align-items: center;
        gap: 15px;
        justify-content: center;
        text-align: center;
    }

    .page-title h1 {
        font-size: 2.5rem;
        color: white;
        text-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    .page-subtitle {
        text-align: center;
        color: rgba(255, 255, 255, 0.9);
        margin-bottom: 30px;
        font-size: 1.1rem;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
    }

    .registration-container {
        display: flex;
        justify-content: center;
        align-items: flex-start;
        min-height: 70vh;
        margin-top: 20px;
    }

    .registration-form {
        background: white;
        padding: 40px;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        width: 100%;
        max-width: 800px;
        border: none;
    }

    .registration-form h2 {
        text-align: center;
        margin-bottom: 30px;
        color: var(--primary);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        font-size: 1.8rem;
    }

    .form-section {
        margin-bottom: 30px;
        padding-bottom: 25px;
        border-bottom: 2px solid var(--light-gray);
    }

    .form-section:last-child {
        border-bottom: none;
    }

    .form-section h3 {
        margin-bottom: 20px;
        color: var(--secondary);
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.3rem;
    }

    .form-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 40px;
        flex-wrap: wrap;
        gap: 20px;
        padding-top: 25px;
        border-top: 2px solid var(--light-gray);
    }

    .form-footer .btn {
        min-width: 150px;
        padding: 16px 30px;
        font-size: 1.1rem;
    }

    /* Admin Info Banner */
    .admin-info-banner {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        padding: 20px;
        border-radius: var(--radius-md);
        margin-bottom: 30px;
        display: flex;
        align-items: center;
        gap: 15px;
        box-shadow: var(--shadow);
    }

    .admin-info-banner i {
        font-size: 1.5rem;
    }

    .admin-info-banner p {
        margin: 0;
        font-size: 1rem;
        flex: 1;
    }

    /* Password Validation Styles */
    .password-validation {
        margin-top: 15px;
        background: #f8f9fa;
        border-radius: var(--radius-md);
        padding: 15px;
    }

    .validation-title {
        font-weight: 500;
        margin-bottom: 10px;
        color: var(--dark);
    }

    .validation-rules {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .validation-rule {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }

    .rule-icon {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
    }

    .rule-icon.valid {
        background-color: #2ecc71;
        color: white;
    }

    .rule-icon.invalid {
        background-color: #e74c3c;
        color: white;
    }

    .rule-icon.pending {
        background-color: #bdc3c7;
        color: white;
    }

    .rule-text {
        flex: 1;
    }

    .rule-text.valid {
        color: #2ecc71;
        font-weight: 500;
    }

    .rule-text.invalid {
        color: #e74c3c;
    }

    .rule-text.pending {
        color: #7f8c8d;
    }

    .terms-agreement {
        margin-top: 20px;
        font-size: 0.9rem;
        color: var(--gray);
        line-height: 1.6;
        text-align: center;
    }

    .terms-agreement a {
        color: var(--primary);
        text-decoration: none;
        font-weight: 500;
    }

    .terms-agreement a:hover {
        text-decoration: underline;
    }

    .login-link {
        text-align: center;
        margin-top: 30px;
        font-size: 1rem;
        color: var(--gray);
    }

    .login-link a {
        color: var(--primary);
        text-decoration: none;
        font-weight: 500;
        margin-left: 5px;
    }

    .login-link a:hover {
        text-decoration: underline;
    }

    /* Loading Overlay */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.95);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        transition: var(--transition);
    }

    .loading-spinner {
        width: 60px;
        height: 60px;
        border: 5px solid var(--light-gray);
        border-top: 5px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }

    .loading-text {
        font-size: 1.2rem;
        color: var(--dark);
        font-weight: 500;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Success/Error Messages */
    .message-box {
        padding: 15px 20px;
        border-radius: var(--radius-md);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 15px;
        animation: slideDown 0.3s ease;
    }

    .message-box.success {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }

    .message-box.error {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }

    .message-box.info {
        background-color: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
    }

    .message-box i {
        font-size: 1.2rem;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Role Selection */
    .role-selection {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }

    .role-option {
        border: 2px solid #dee2e6;
        border-radius: var(--radius-md);
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
    }

    .role-option:hover {
        border-color: var(--primary);
        transform: translateY(-2px);
        box-shadow: var(--shadow);
    }

    .role-option.selected {
        border-color: var(--primary);
        background-color: rgba(67, 97, 238, 0.1);
        box-shadow: var(--shadow);
    }

    .role-icon {
        font-size: 2rem;
        margin-bottom: 10px;
        color: var(--primary);
    }

    .role-title {
        font-weight: 600;
        margin-bottom: 5px;
        color: var(--dark);
    }

    .role-description {
        font-size: 0.85rem;
        color: var(--gray);
    }

    input[type="radio"] {
        display: none;
    }

    @media (max-width: 768px) {
        .form-footer {
            flex-direction: column;
            align-items: stretch;
        }
        
        .form-footer .btn {
            width: 100%;
        }
        
        .registration-form {
            padding: 25px;
        }
        
        .header-content {
            flex-direction: column;
            gap: 15px;
            text-align: center;
        }
        
        .logo {
            flex-direction: column;
            text-align: center;
        }
        
        .page-title h1 {
            font-size: 2rem;
        }
        
        .role-selection {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 576px) {
        .registration-form {
            padding: 20px;
        }
        
        .page-title h1 {
            font-size: 1.8rem;
        }
        
        .container {
            padding: 15px;
        }
        
        .main {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
    }
</style>
</head>
<body>
  
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: flex;">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loading-text">Initializing Admin Panel...</div>
    </div>

    <div class="main">
        <div class="a-header">
            <div class="header-content">
                <a href="index.html" class="logo">
                    <img src="https://via.placeholder.com/60x60/4361ee/ffffff?text=S" alt="KSITM CTE" class="logo-img">
                    <div class="logo-text">
                        <div class="logo-title">KSITM CTE Admin</div>
                        <div class="logo-subtitle">User Management Portal</div>
                    </div>
                </a>
                <div class="user-info">
                    <span class="user-greeting" id="user-greeting"></span>
                    <a href="dashboard.html" class="btn btn-outline">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </a>
                </div>
            </div>
        </div>
        
        <div class="container">
            <div class="page-title">
                <h1><i class="fas fa-user-plus"></i> Create User Account</h1>
            </div>

            <div class="page-subtitle">
                Create new student or student admin accounts. This page is accessible only to administrators and HODs.
            </div>

            <div class="registration-container">
                <form class="registration-form" id="registration-form">
                    <!-- Admin Info Banner -->
                    <div class="admin-info-banner" id="admin-info-banner">
                        <i class="fas fa-user-shield"></i>
                        <p>You are creating a user account as an administrator. No activation code is required.</p>
                    </div>

                    <!-- Success/Error Messages -->
                    <div id="message-container"></div>
                    
                    <!-- Personal Information Section -->
                    <div class="form-section">
                        <h3><i class="fas fa-user-circle"></i> Personal Information</h3>
                        
                        <div class="form-group">
                            <label for="fullName">Full Name <span class="required">*</span></label>
                            <input type="text" id="fullName" class="form-control" required placeholder="Enter user's full name as on official records">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="email">Email Address <span class="required">*</span></label>
                                <input type="email" id="email" class="form-control" required placeholder="user@ksitm.edu.ng">
                                <small class="text-muted">This will be used for login and notifications</small>
                            </div>
                            <div class="form-group">
                                <label for="phone">Phone Number <span class="required">*</span></label>
                                <input type="tel" id="phone" class="form-control" required placeholder="+234 800 000 0000">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="reg-number">Registration Number <span class="required">*</span></label>
                                <input type="text" id="reg-number" class="form-control" required placeholder="KSITM/CTE/24/001">
                            </div>
                            <div class="form-group">
                                <label for="entry-year">Entry Year</label>
                                <select id="entry-year" class="form-control">
                                    <option value="">Select Year</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Academic Information Section -->
                    <div class="form-section">
                        <h3><i class="fas fa-graduation-cap"></i> Academic Information</h3>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="department">Department <span class="required">*</span></label>
                                <select id="department" class="form-control" required>
                                    <option value="">Select Department</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="faculty">Faculty <span class="required">*</span></label>
                                <select id="faculty" class="form-control" required>
                                    <option value="">Select Faculty</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="level">Academic Level <span class="required">*</span></label>
                                <select id="level" class="form-control" required>
                                    <option value="">Select Level</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="jamb-number">JAMB Registration Number</label>
                                <input type="text" id="jamb-number" class="form-control" placeholder="e.g., 12345678AB">
                            </div>
                        </div>
                    </div>
                    
                    <!-- User Role Selection -->
                    <div class="form-section">
                        <h3><i class="fas fa-user-tag"></i> User Role <span class="required">*</span></h3>
                        
                        <div class="role-selection" id="role-selection">
                            <!-- Roles will be populated from database -->
                        </div>
                        
                        <input type="hidden" id="selected-role" required>
                        
                        <div class="form-row" style="margin-top: 20px;">
                            <div class="form-group">
                                <label for="status">Account Status <span class="required">*</span></label>
                                <select id="status" class="form-control" required>
                                    <option value="Active">Active</option>
                                    <option value="Inactive">Inactive</option>
                                    <option value="Pending">Pending</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Account Security Section -->
                    <div class="form-section">
                        <h3><i class="fas fa-shield-alt"></i> Account Security</h3>
                        
                        <div class="form-group">
                            <label for="password">Password <span class="required">*</span></label>
                            <div class="password-container">
                                <input type="password" id="password" class="form-control" required placeholder="Create a password (min. 6 characters)">
                                <button type="button" class="toggle-password" id="toggle-password">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            
                            <!-- Password Validation Rules -->
                            <div class="password-validation">
                                <div class="validation-title">Password must contain:</div>
                                <div class="validation-rules">
                                    <div class="validation-rule" id="rule-length">
                                        <div class="rule-icon pending">
                                            <i class="fas fa-circle"></i>
                                        </div>
                                        <div class="rule-text pending">At least 6 characters</div>
                                    </div>
                                    <div class="validation-rule" id="rule-uppercase">
                                        <div class="rule-icon pending">
                                            <i class="fas fa-circle"></i>
                                        </div>
                                        <div class="rule-text pending">At least 1 uppercase letter (A-Z)</div>
                                    </div>
                                    <div class="validation-rule" id="rule-lowercase">
                                        <div class="rule-icon pending">
                                            <i class="fas fa-circle"></i>
                                        </div>
                                        <div class="rule-text pending">At least 1 lowercase letter (a-z)</div>
                                    </div>
                                    <div class="validation-rule" id="rule-number">
                                        <div class="rule-icon pending">
                                            <i class="fas fa-circle"></i>
                                        </div>
                                        <div class="rule-text pending">At least 1 number (0-9)</div>
                                    </div>
                                    <div class="validation-rule" id="rule-match">
                                        <div class="rule-icon pending">
                                            <i class="fas fa-circle"></i>
                                        </div>
                                        <div class="rule-text pending">Passwords must match</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="confirmPassword">Confirm Password <span class="required">*</span></label>
                            <div class="password-container">
                                <input type="password" id="confirmPassword" class="form-control" required placeholder="Confirm your password">
                                <button type="button" class="toggle-password" id="toggle-confirm-password">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Terms and Agreement -->
                    <div class="terms-agreement">
                        By creating an account, the user agrees to the 
                        <a href="#" onclick="return false">KSITM CTE Terms of Service</a> and 
                        <a href="#" onclick="return false">Privacy Policy</a>. 
                        Account will be created with the selected role and status.
                    </div>
                    
                    <!-- Form Actions -->
                    <div class="form-footer">
                        <button type="button" class="btn btn-danger" id="reset-btn">
                            <i class="fas fa-redo"></i> Clear Form
                        </button>
                        <button type="button" class="btn btn-primary" id="submit-btn">
                            <i class="fas fa-user-plus"></i> Create User Account
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div id="toast" class="toast"></div>
    </div>

    <!-- Include the consolidated school app JS -->
    <script src="js/school-app.js"></script>
    
    <!-- Admin Signup Script -->

<script>
    // Admin signup page specific functions
    let schoolConfig = null;
    let userData = null;
    let isInitialized = false;
    let configListener = null;

    // Page-specific authentication functions
    const AuthManager = {
        currentUser: null,
        userData: null,

        initialize: function() {
            return new Promise((resolve, reject) => {
                firebase.auth().onAuthStateChanged(async (user) => {
                    if (user) {
                        this.currentUser = user;
                        await this.loadUserData(user.uid);
                        resolve(user);
                    } else {
                        this.currentUser = null;
                        this.userData = null;
                        resolve(null);
                    }
                });
            });
        },

        loadUserData: async function(uid) {
            try {
                const doc = await firebase.firestore().collection('users').doc(uid).get();
                if (doc.exists) {
                    this.userData = { uid, ...doc.data() };
                    localStorage.setItem('currentUser', JSON.stringify(this.userData));
                }
            } catch (error) {
                console.error("Error loading user data:", error);
            }
        },

        getCurrentUser: function() {
            return this.currentUser;
        },

        getUserData: function() {
            return this.userData;
        },

        getRole: function() {
            return this.userData?.role || 'Student';
        },

        isAdmin: function() {
            const adminRoles = ['Admin', 'Lecturer', 'HOD', 'Dean'];
            return this.userData && adminRoles.includes(this.userData.role);
        },

        login: async function(email, password) {
            try {
                const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
                
                // Update last login
                await firebase.firestore().collection('users').doc(userCredential.user.uid).update({
                    lastLoginAt: new Date().toISOString()
                });
                
                await this.loadUserData(userCredential.user.uid);
                return { success: true, user: userCredential.user };
            } catch (error) {
                let errorMessage = 'Login failed';
                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMessage = 'User not found';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = 'Incorrect password';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Invalid email format';
                        break;
                    default:
                        errorMessage = error.message;
                }
                return { success: false, error: errorMessage };
            }
        },

        logout: async function() {
            try {
                await firebase.auth().signOut();
                this.currentUser = null;
                this.userData = null;
                localStorage.removeItem('currentUser');
                return { success: true };
            } catch (error) {
                return { success: false, error: error.message };
            }
        },

        register: async function(userData) {
            try {
                const userCredential = await firebase.auth().createUserWithEmailAndPassword(
                    userData.email, 
                    userData.password
                );
                
                return { success: true, user: userCredential.user, uid: userCredential.user.uid };
            } catch (error) {
                let errorMessage = 'Registration failed';
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = 'Email already registered';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Invalid email address';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'Password is too weak';
                        break;
                    default:
                        errorMessage = error.message;
                }
                return { success: false, error: errorMessage };
            }
        },

        updateProfile: async function(uid, profileData) {
            try {
                const updateData = {
                    ...profileData,
                    updatedAt: new Date().toISOString()
                };
                
                await firebase.firestore().collection('users').doc(uid).update(updateData);
                return { success: true };
            } catch (error) {
                return { success: false, error: error.message };
            }
        },

        changePassword: async function(currentPassword, newPassword) {
            try {
                const user = this.currentUser;
                const credential = firebase.auth.EmailAuthProvider.credential(
                    user.email, 
                    currentPassword
                );
                
                await user.reauthenticateWithCredential(credential);
                await user.updatePassword(newPassword);
                return { success: true };
            } catch (error) {
                return { success: false, error: error.message };
            }
        },

        forgotPassword: async function(email) {
            try {
                await firebase.auth().sendPasswordResetEmail(email);
                return { success: true };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }
    };

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        initializePage();
    });

    // Initialize the page with loading state
    async function initializePage() {
        try {
            showLoading(true, 'Checking admin access...');
            
            // Initialize Firebase and check authentication
            await AuthManager.initialize();
            
            // Check if user is logged in
            const currentUser = AuthManager.getCurrentUser();
            if (!currentUser) {
                showMessage('Please login to access this page', 'error');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return;
            }
            
            // Load user data
            userData = AuthManager.getUserData();
            if (!userData) {
                showMessage('Loading user data...', 'info');
                userData = await AuthManager.loadUserData(currentUser.uid);
            }
            
            // Check if user has permission (Admin or HOD)
            const allowedRoles = ['Admin', 'HOD'];
            if (!userData || !allowedRoles.includes(userData.role)) {
                showMessage('Access denied. Admin or HOD privileges required.', 'error');
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 3000);
                return;
            }
            
            // Update UI with user info
            document.getElementById('user-greeting').innerHTML = `
                <i class="fas fa-user-circle"></i> ${userData.fullName} (${userData.role})
            `;
            
            // Setup realtime config listener
            setupRealtimeConfig();
            
            // Setup event listeners
            setupEventListeners();
            
            // Populate current year in entry year dropdown
            populateYearDropdown();
            
            isInitialized = true;
            showMessage('Admin panel ready. You can now create user accounts.', 'success');
            
        } catch (error) {
            console.error('Initialization error:', error);
            showMessage('Error initializing: ' + error.message, 'error');
        } finally {
            showLoading(false);
        }
    }

    function setupEventListeners() {
        document.getElementById('submit-btn').addEventListener('click', handleUserCreation);
        document.getElementById('reset-btn').addEventListener('click', resetForm);
        
        document.getElementById('toggle-password').addEventListener('click', function() {
            togglePasswordVisibility('password', this);
        });
        
        document.getElementById('toggle-confirm-password').addEventListener('click', function() {
            togglePasswordVisibility('confirmPassword', this);
        });
        
        // Real-time password validation
        document.getElementById('password').addEventListener('input', function() {
            validatePassword();
        });
        
        document.getElementById('confirmPassword').addEventListener('input', function() {
            validatePasswordMatch();
        });
        
        // Form field validation on blur
        const requiredFields = ['fullName', 'email', 'phone', 'reg-number', 'department', 'faculty', 'level'];
        requiredFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.addEventListener('blur', function() {
                    validateField(this);
                });
            }
        });
    }

    function setupRealtimeConfig() {
        // Set up real-time listener for school config
        configListener = firebase.firestore().collection('schoolConfig').doc('main')
            .onSnapshot(snapshot => {
                if (snapshot.exists) {
                    schoolConfig = snapshot.data();
                    updateDropdowns(schoolConfig);
                    updateRoleSelection(schoolConfig);
                }
            }, error => {
                console.error('Realtime config error:', error);
                showMessage('Error loading configuration: ' + error.message, 'error');
            });
    }

    function updateDropdowns(config) {
        // Update departments dropdown
        const deptSelect = document.getElementById('department');
        updateSelectOptions(deptSelect, config.departments || []);
        
        // Update faculties dropdown
        const facultySelect = document.getElementById('faculty');
        updateSelectOptions(facultySelect, config.faculties || []);
        
        // Update academic levels dropdown
        const levelSelect = document.getElementById('level');
        updateSelectOptions(levelSelect, config.academicLevels || []);
    }

    function updateSelectOptions(selectElement, options) {
        // Save current value
        const currentValue = selectElement.value;
        
        // Clear existing options except the first
        while (selectElement.options.length > 1) {
            selectElement.remove(1);
        }
        
        // Add new options
        if (options && options.length > 0) {
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                selectElement.appendChild(optionElement);
            });
            
            // Restore selected value if it exists in new options
            if (currentValue && options.includes(currentValue)) {
                selectElement.value = currentValue;
            }
        }
    }

    function updateRoleSelection(config) {
        const roleSelectionDiv = document.getElementById('role-selection');
        const roles = config.userRoles || [];
        
        // Filter to only show Student and Student Admin roles
        const allowedRoles = roles.filter(role => 
            role.toLowerCase().includes('student') || 
            role.toLowerCase().includes('admin')
        );
        
        if (allowedRoles.length === 0) {
            roleSelectionDiv.innerHTML = `
                <div class="message-box error">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>No suitable roles found in configuration. Please configure roles in school settings.</div>
                </div>
            `;
            return;
        }
        
        let html = '';
        allowedRoles.forEach(role => {
            const roleLower = role.toLowerCase();
            let icon = 'fas fa-user';
            let description = 'Standard user account';
            
            if (roleLower.includes('admin')) {
                icon = 'fas fa-user-shield';
                description = 'Student with administrative privileges';
            } else if (roleLower.includes('student')) {
                icon = 'fas fa-user-graduate';
                description = 'Standard student account';
            }
            
            html += `
                <label class="role-option">
                    <input type="radio" name="user-role" value="${role}" onchange="selectRole('${role}')">
                    <div class="role-icon">
                        <i class="${icon}"></i>
                    </div>
                    <div class="role-title">${role}</div>
                    <div class="role-description">${description}</div>
                </label>
            `;
        });
        
        roleSelectionDiv.innerHTML = html;
    }

    function selectRole(role) {
        document.getElementById('selected-role').value = role;
        
        // Update UI to show selected role
        const roleOptions = document.querySelectorAll('.role-option');
        roleOptions.forEach(option => {
            if (option.querySelector('input').value === role) {
                option.classList.add('selected');
            } else {
                option.classList.remove('selected');
            }
        });
    }

    function populateYearDropdown() {
        const yearSelect = document.getElementById('entry-year');
        const currentYear = new Date().getFullYear();
        
        // Add years from current year to 10 years back
        for (let year = currentYear; year >= currentYear - 10; year--) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            yearSelect.appendChild(option);
        }
    }

    function validateField(field) {
        if (field.hasAttribute('required') && !field.value.trim()) {
            field.classList.add('invalid');
            field.classList.remove('valid');
            return false;
        }
        
        // Email validation
        if (field.type === 'email' && field.value.trim()) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(field.value)) {
                field.classList.add('invalid');
                field.classList.remove('valid');
                return false;
            }
        }
        
        field.classList.add('valid');
        field.classList.remove('invalid');
        return true;
    }

    function validatePassword() {
        const password = document.getElementById('password').value;
        
        // Validate length
        const lengthValid = password.length >= 6;
        updateValidationRule('length', lengthValid);
        
        // Validate uppercase
        const uppercaseValid = /[A-Z]/.test(password);
        updateValidationRule('uppercase', uppercaseValid);
        
        // Validate lowercase
        const lowercaseValid = /[a-z]/.test(password);
        updateValidationRule('lowercase', lowercaseValid);
        
        // Validate number
        const numberValid = /[0-9]/.test(password);
        updateValidationRule('number', numberValid);
        
        // Validate match (if confirm password is filled)
        if (document.getElementById('confirmPassword').value) {
            validatePasswordMatch();
        }
    }

    function validatePasswordMatch() {
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const matchValid = password === confirmPassword && password.length > 0;
        updateValidationRule('match', matchValid);
    }

    function updateValidationRule(ruleId, isValid) {
        const ruleElement = document.getElementById(`rule-${ruleId}`);
        if (!ruleElement) return;
        
        const iconElement = ruleElement.querySelector('.rule-icon');
        const textElement = ruleElement.querySelector('.rule-text');
        
        if (isValid) {
            iconElement.className = 'rule-icon valid';
            iconElement.innerHTML = '<i class="fas fa-check"></i>';
            textElement.className = 'rule-text valid';
        } else {
            iconElement.className = 'rule-icon invalid';
            iconElement.innerHTML = '<i class="fas fa-times"></i>';
            textElement.className = 'rule-text invalid';
        }
    }

    async function handleUserCreation(e) {
        e.preventDefault();
        
        if (!isInitialized) {
            showMessage('System still initializing. Please wait...', 'warning');
            return;
        }
        
        // Validate all required fields
        const requiredFields = [
            'fullName', 'email', 'phone', 'reg-number', 
            'department', 'faculty', 'level', 'selected-role', 'status'
        ];
        
        for (const fieldId of requiredFields) {
            const field = document.getElementById(fieldId);
            if (field && !field.value.trim()) {
                showMessage(`${field.previousElementSibling?.textContent || 'Field'} is required`, 'error');
                field.focus();
                return;
            }
        }
        
        // Validate email format
        const email = document.getElementById('email').value.trim();
        if (!window.SchoolApp.SchoolUtils.validateEmail(email)) {
            showMessage('Please enter a valid email address', 'error');
            document.getElementById('email').focus();
            return;
        }
        
        // Validate password
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        if (password !== confirmPassword) {
            showMessage('Passwords do not match', 'error');
            return;
        }
        
        if (password.length < 6) {
            showMessage('Password must be at least 6 characters long', 'error');
            return;
        }
        
        if (!/[A-Z]/.test(password)) {
            showMessage('Password must contain at least one uppercase letter', 'error');
            return;
        }
        
        if (!/[a-z]/.test(password)) {
            showMessage('Password must contain at least one lowercase letter', 'error');
            return;
        }
        
        if (!/[0-9]/.test(password)) {
            showMessage('Password must contain at least one number', 'error');
            return;
        }
        
        // Check if registration number already exists
        const regNumber = document.getElementById('reg-number').value.trim();
        const regExists = await checkRegistrationNumberExists(regNumber);
        if (regExists) {
            showMessage('Registration number already exists', 'error');
            return;
        }
        
        // Check if email already exists
        const emailExists = await checkEmailExists(email);
        if (emailExists) {
            showMessage('Email address already exists', 'error');
            return;
        }
        
        // Proceed with user creation
        await createUserAccount();
    }

    async function checkRegistrationNumberExists(regNumber) {
        try {
            const snapshot = await firebase.firestore().collection('users')
                .where('regNumber', '==', regNumber)
                .limit(1)
                .get();
            return !snapshot.empty;
        } catch (error) {
            console.error('Error checking registration number:', error);
            return false;
        }
    }

    async function checkEmailExists(email) {
        try {
            const snapshot = await firebase.firestore().collection('users')
                .where('email', '==', email)
                .limit(1)
                .get();
            return !snapshot.empty;
        } catch (error) {
            console.error('Error checking email:', error);
            return false;
        }
    }

    async function createUserAccount() {
        const submitBtn = document.getElementById('submit-btn');
        const originalText = submitBtn.innerHTML;
        
        // Show loading state
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; display: inline-block;"></div> Creating Account...';
        
        try {
            const userData = {
                fullName: document.getElementById('fullName').value.trim(),
                email: document.getElementById('email').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                regNumber: document.getElementById('reg-number').value.trim(),
                department: document.getElementById('department').value,
                faculty: document.getElementById('faculty').value,
                level: document.getElementById('level').value,
                role: document.getElementById('selected-role').value,
                status: document.getElementById('status').value,
                jambNumber: document.getElementById('jamb-number').value.trim() || '',
                entryYear: document.getElementById('entry-year').value || new Date().getFullYear().toString(),
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                createdBy: AuthManager.getCurrentUser()?.uid || '',
                createdByName: AuthManager.getUserData()?.fullName || 'Admin'
            };
            
            const password = document.getElementById('password').value;
            
            // Create user in Firebase Auth
            const authResult = await AuthManager.register({
                email: userData.email,
                password: password,
                additionalData: userData
            });
            
            if (!authResult.success) {
                throw new Error(authResult.error || 'Failed to create user');
            }
            
            // Add user data to Firestore
            await firebase.firestore().collection('users').doc(authResult.uid).set(userData);
            
            // Log the creation
            await logUserCreation(userData, authResult.uid);
            
            showMessage(`User account created successfully! ${userData.fullName} can now login with their email.`, 'success');
            
            // Reset form after successful creation
            setTimeout(() => {
                resetForm();
            }, 2000);
            
        } catch (error) {
            console.error('Error creating user:', error);
            showMessage('Error creating user: ' + error.message, 'error');
        } finally {
            // Restore button state
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    }

    async function logUserCreation(userData, userId) {
        try {
            const logData = {
                action: 'USER_CREATED',
                targetUserId: userId,
                targetUserName: userData.fullName,
                targetUserEmail: userData.email,
                targetUserRole: userData.role,
                performedBy: AuthManager.getCurrentUser()?.uid,
                performedByName: AuthManager.getUserData()?.fullName,
                timestamp: new Date().toISOString(),
                details: {
                    department: userData.department,
                    faculty: userData.faculty,
                    level: userData.level,
                    status: userData.status
                }
            };
            
            await firebase.firestore().collection('auditLogs').add(logData);
        } catch (error) {
            console.error('Error logging user creation:', error);
        }
    }

    function resetForm() {
        if (confirm('Are you sure you want to clear all form fields?')) {
            document.getElementById('registration-form').reset();
            
            // Reset role selection
            const roleOptions = document.querySelectorAll('.role-option');
            roleOptions.forEach(option => {
                option.classList.remove('selected');
            });
            
            // Reset validation rules
            resetValidationRules();
            
            // Reset field validation styles
            const validatedFields = document.querySelectorAll('.valid, .invalid');
            validatedFields.forEach(field => {
                field.classList.remove('valid', 'invalid');
            });
            
            // Clear messages
            document.getElementById('message-container').innerHTML = '';
            
            // Focus on first field
            document.getElementById('fullName').focus();
            
            showMessage('Form cleared. You can create another user.', 'info');
        }
    }

    function resetValidationRules() {
        const rules = ['length', 'uppercase', 'lowercase', 'number', 'match'];
        rules.forEach(ruleId => {
            const ruleElement = document.getElementById(`rule-${ruleId}`);
            if (ruleElement) {
                const iconElement = ruleElement.querySelector('.rule-icon');
                const textElement = ruleElement.querySelector('.rule-text');
                iconElement.className = 'rule-icon pending';
                iconElement.innerHTML = '<i class="fas fa-circle"></i>';
                textElement.className = 'rule-text pending';
            }
        });
    }

    function togglePasswordVisibility(inputId, button) {
        const input = document.getElementById(inputId);
        const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
        input.setAttribute('type', type);
        button.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
    }

    function showLoading(show, text = 'Loading...') {
        const overlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        
        if (show) {
            loadingText.textContent = text;
            overlay.style.display = 'flex';
        } else {
            overlay.style.display = 'none';
        }
    }

    function showMessage(message, type = 'success') {
        const container = document.getElementById('message-container');
        const icon = type === 'success' ? 'fa-check-circle' : 
                    type === 'error' ? 'fa-exclamation-circle' : 
                    'fa-info-circle';
        
        const messageHtml = `
            <div class="message-box ${type}">
                <i class="fas ${icon}"></i>
                <div>${message}</div>
            </div>
        `;
        
        container.innerHTML = messageHtml;
        
        // Auto-remove success messages after 5 seconds
        if (type === 'success') {
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }
    }
</script>
</body>
</html>