<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile - KSITM CTE Portal</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="css/style.css">
<style>
    /* Profile Page Specific Styles */
    * {
        box-sizing: border-box;
    }
    
    body {
        background-color: #f5f7fa;
        min-height: 100vh;
        padding: 20px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .profile-container {
        max-width: 1000px;
        margin: 20px auto;
        background-color: var(--bg-color);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
        overflow: hidden;
        transition: var(--transition);
    }

    .profile-header {
        padding: 30px;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        text-align: center;
        position: relative;
    }

    .profile-header h1 {
        font-size: 2rem;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        flex-wrap: wrap;
    }

    .profile-header p {
        opacity: 0.9;
        font-size: 1rem;
        max-width: 600px;
        margin: 0 auto;
    }

    .user-role-badge {
        background: rgba(255, 255, 255, 0.2);
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.85rem;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        margin-top: 10px;
    }

    .profile-content {
        padding: 30px;
    }

    .profile-picture-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 40px;
        position: relative;
    }

    .profile-picture-container {
        position: relative;
        margin-bottom: 20px;
    }

    .profile-picture {
        width: 160px;
        height: 160px;
        border-radius: 50%;
        object-fit: cover;
        border: 5px solid var(--primary);
        background-color: var(--primary-light);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        font-weight: bold;
        box-shadow: 0 6px 20px rgba(146, 15, 9, 0.3);
        transition: var(--transition);
    }

    .profile-picture:hover {
        transform: scale(1.05);
        box-shadow: 0 8px 25px rgba(146, 15, 9, 0.4);
    }

    .upload-overlay {
        position: absolute;
        bottom: 10px;
        right: 10px;
        background: var(--primary);
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: var(--transition);
        border: 3px solid white;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
    }

    .upload-overlay:hover {
        background: var(--secondary);
        transform: scale(1.1);
    }

    .upload-progress {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 50%;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 10;
        backdrop-filter: blur(2px);
    }

    .upload-progress.active {
        display: flex;
        animation: fadeIn 0.3s ease;
    }

    .progress-circle {
        width: 60px;
        height: 60px;
        border: 4px solid var(--light-gray);
        border-top: 4px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 10px;
    }

    .progress-text {
        font-size: 0.85rem;
        color: var(--dark);
        font-weight: 500;
        text-align: center;
    }

    .upload-error {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--danger);
        color: white;
        padding: 10px;
        border-radius: var(--radius-sm);
        margin-top: 10px;
        font-size: 0.85rem;
        display: none;
        align-items: center;
        gap: 8px;
        justify-content: center;
        animation: slideDown 0.3s ease;
        z-index: 100;
    }

    .upload-error.show {
        display: flex;
    }

    .profile-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
    }

    .form-section {
        padding: 25px;
        background-color: white;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow);
        border: 1px solid var(--light-gray);
    }

    .form-section h3 {
        margin-bottom: 25px;
        color: var(--primary);
        border-bottom: 2px solid var(--primary);
        padding-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 1.3rem;
    }

    .form-section h3 i {
        font-size: 1.2rem;
    }

    /* Enhanced form responsiveness */
    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    @media (max-width: 768px) {
        .form-row {
            grid-template-columns: 1fr;
        }
    }

    .form-group {
        margin-bottom: 20px;
        position: relative;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--dark);
        font-size: 0.95rem;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 14px;
        border: 2px solid var(--light-gray);
        border-radius: var(--radius-md);
        font-size: 1rem;
        transition: var(--transition);
        background-color: var(--bg-color);
        font-family: inherit;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(146, 15, 9, 0.1);
    }

    .form-group input[readonly],
    .form-group input:disabled {
        background-color: #f8f9fa;
        border-color: #e9ecef;
        color: var(--gray);
        cursor: not-allowed;
        opacity: 0.8;
    }

    .form-actions {
        display: flex;
        gap: 15px;
        justify-content: flex-end;
        margin-top: 30px;
        padding-top: 25px;
        border-top: 2px solid var(--light-gray);
    }

    .save-btn, .cancel-btn, .auth-btn {
        padding: 12px 25px;
        border: none;
        border-radius: var(--radius-md);
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 140px;
        justify-content: center;
    }

    .save-btn {
        background-color: var(--primary);
        color: white;
    }

    .save-btn:hover:not(:disabled) {
        background-color: var(--secondary);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .save-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
        box-shadow: none !important;
    }

    .cancel-btn {
        background-color: var(--light-gray);
        color: var(--dark);
    }

    .cancel-btn:hover {
        background-color: #dee2e6;
        transform: translateY(-2px);
    }

    .auth-btn {
        background-color: var(--info);
        color: white;
    }

    .auth-btn:hover:not(:disabled) {
        background-color: #2980b9;
        transform: translateY(-2px);
    }

    .auth-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
    }

    /* Academic Info Styles */
    .academic-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 15px;
    }

    .academic-card {
        background: white;
        border-radius: var(--radius-md);
        padding: 20px;
        border-left: 4px solid var(--primary);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        transition: var(--transition);
    }

    .academic-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .academic-card .info-label {
        font-size: 0.85rem;
        color: var(--gray);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .academic-card .info-value {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--dark);
    }

    .academic-card .info-value.cgpa {
        color: #27ae60;
        font-size: 1.4rem;
    }

    .academic-card .info-value.status-active {
        color: #27ae60;
    }

    .academic-card .info-value.status-inactive {
        color: #e74c3c;
    }

    .academic-card .info-value.status-pending {
        color: #f39c12;
    }

    /* Security Section */
    .security-section {
        position: relative;
    }

    .password-form {
        display: none;
        margin-top: 20px;
        padding: 25px;
        background: #f8f9fa;
        border-radius: var(--radius-md);
        border: 1px solid #e9ecef;
    }

    .password-form.active {
        display: block;
        animation: slideDown 0.4s ease;
    }

    .toggle-password-form {
        position: absolute;
        top: 25px;
        right: 25px;
        background: none;
        border: 2px solid var(--primary);
        color: var(--primary);
        padding: 8px 16px;
        border-radius: var(--radius-sm);
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: var(--transition);
    }

    .toggle-password-form:hover {
        background-color: var(--primary);
        color: white;
    }

    /* Danger Zone */
    .danger-zone {
        margin-top: 40px;
        padding: 30px;
        background: linear-gradient(135deg, #ffebee, #ffcdd2);
        border-radius: var(--radius-lg);
        border-left: 5px solid var(--danger);
        box-shadow: 0 4px 15px rgba(244, 67, 54, 0.1);
    }

    .danger-zone h3 {
        color: var(--danger);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 1.3rem;
    }

    .danger-zone p {
        color: #c62828;
        font-size: 0.95rem;
        margin-bottom: 25px;
        line-height: 1.6;
        opacity: 0.9;
    }

    .danger-actions {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }

    .logout-btn, .delete-account-btn {
        padding: 14px 25px;
        border: none;
        border-radius: var(--radius-md);
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 10px;
        flex: 1;
        min-width: 200px;
        justify-content: center;
    }

    .logout-btn {
        background-color: var(--warning);
        color: white;
    }

    .logout-btn:hover {
        background-color: #e67e22;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(230, 126, 34, 0.2);
    }

    .delete-account-btn {
        background-color: var(--danger);
        color: white;
    }

    .delete-account-btn:hover {
        background-color: #d32f2f;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(211, 47, 47, 0.2);
    }

    /* Loading States */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.95);
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 10000;
    }

    .loading-overlay.active {
        display: flex;
        animation: fadeIn 0.3s ease;
    }

    .loading-spinner-large {
        width: 70px;
        height: 70px;
        border: 6px solid var(--light-gray);
        border-top: 6px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }

    .loading-text {
        font-size: 1.2rem;
        color: var(--dark);
        font-weight: 500;
    }

    /* Custom Modal */
    .custom-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10001;
        opacity: 0;
        visibility: hidden;
        transition: var(--transition);
        padding: 20px;
    }

    .custom-modal.active {
        opacity: 1;
        visibility: visible;
    }

    .modal-content {
        background: white;
        border-radius: var(--radius-lg);
        width: 90%;
        max-width: 500px;
        overflow: hidden;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        transform: translateY(20px);
        transition: transform 0.3s ease;
    }

    .custom-modal.active .modal-content {
        transform: translateY(0);
    }

    .modal-header {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        padding: 25px;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .modal-header h2 {
        font-size: 1.5rem;
        margin: 0;
        flex: 1;
    }

    .modal-icon {
        font-size: 2rem;
    }

    .modal-body {
        padding: 30px;
        color: var(--dark);
        line-height: 1.6;
        font-size: 1.05rem;
    }

    .modal-footer {
        padding: 25px;
        border-top: 1px solid var(--light-gray);
        display: flex;
        justify-content: flex-end;
        gap: 15px;
    }

    .modal-btn {
        padding: 12px 25px;
        border: none;
        border-radius: var(--radius-md);
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
        min-width: 120px;
    }

    .modal-btn-cancel {
        background-color: var(--light-gray);
        color: var(--dark);
    }

    .modal-btn-cancel:hover {
        background-color: #dee2e6;
    }

    .modal-btn-confirm {
        background-color: var(--primary);
        color: white;
    }

    .modal-btn-confirm:hover {
        background-color: var(--secondary);
    }

    .modal-btn-danger {
        background-color: var(--danger);
        color: white;
    }

    .modal-btn-danger:hover {
        background-color: #d32f2f;
    }

    /* Toast Notifications */
    .profile-toast {
        position: fixed;
        bottom: 30px;
        right: 30px;
        padding: 15px 25px;
        border-radius: var(--radius-md);
        color: white;
        font-weight: 500;
        z-index: 1000;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.3s ease;
        max-width: 400px;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .profile-toast.show {
        opacity: 1;
        transform: translateY(0);
    }

    .profile-toast.success {
        background-color: var(--success);
    }

    .profile-toast.error {
        background-color: var(--danger);
    }

    .profile-toast.warning {
        background-color: var(--warning);
    }

    .profile-toast.info {
        background-color: var(--info);
    }

    /* Password Validation Styles */
    .password-validation {
        margin-top: 15px;
        background: #f8f9fa;
        border-radius: var(--radius-md);
        padding: 15px;
    }

    .validation-title {
        font-weight: 500;
        margin-bottom: 10px;
        color: var(--dark);
    }

    .validation-rules {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .validation-rule {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }

    .rule-icon {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
    }

    .rule-icon.valid {
        background-color: var(--success);
        color: white;
    }

    .rule-icon.invalid {
        background-color: var(--danger);
        color: white;
    }

    .rule-icon.pending {
        background-color: #bdc3c7;
        color: white;
    }

    .rule-text {
        flex: 1;
    }

    .rule-text.valid {
        color: var(--success);
        font-weight: 500;
    }

    .rule-text.invalid {
        color: var(--danger);
    }

    .rule-text.pending {
        color: #7f8c8d;
    }

    /* Animations */
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        body {
            padding: 10px;
        }
        
        .profile-header {
            padding: 25px 20px;
        }
        
        .profile-header h1 {
            font-size: 1.6rem;
            flex-direction: column;
            gap: 10px;
        }
        
        .profile-content {
            padding: 20px;
        }
        
        .profile-picture {
            width: 140px;
            height: 140px;
        }
        
        .profile-info-grid {
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        .form-section {
            padding: 20px;
        }
        
        .danger-actions {
            flex-direction: column;
        }
        
        .logout-btn, .delete-account-btn {
            min-width: 100%;
        }
        
        .form-actions {
            flex-direction: column;
        }
        
        .save-btn, .cancel-btn, .auth-btn {
            width: 100%;
        }
        
        .toggle-password-form {
            position: relative;
            top: 0;
            right: 0;
            margin-top: 10px;
            width: 100%;
            justify-content: center;
        }
        
        .modal-content {
            width: 95%;
        }
        
        .modal-footer {
            flex-direction: column;
        }
        
        .modal-btn {
            width: 100%;
        }
    }

    @media (max-width: 480px) {
        .profile-picture {
            width: 120px;
            height: 120px;
            font-size: 2.5rem;
        }
        
        .academic-info-grid {
            grid-template-columns: 1fr;
        }
        
        .profile-toast {
            left: 20px;
            right: 20px;
            bottom: 20px;
            max-width: none;
        }
    }

    /* Field States */
    .form-group.valid input:not([readonly]):not([disabled]),
    .form-group.valid select:not([disabled]) {
        border-color: var(--success);
        background-color: rgba(46, 204, 113, 0.05);
    }

    .form-group.invalid input:not([readonly]):not([disabled]),
    .form-group.invalid select:not([disabled]) {
        border-color: var(--danger);
        background-color: rgba(231, 76, 60, 0.05);
    }

    .validation-message {
        font-size: 0.85rem;
        margin-top: 5px;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .validation-message.valid {
        color: var(--success);
    }

    .validation-message.invalid {
        color: var(--danger);
    }

    /* Dropdown Styles */
    select.form-control {
        appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 15px center;
        background-size: 15px;
        padding-right: 40px;
    }

    /* Disabled field styling */
    .field-disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }

    .field-disabled-text {
        font-size: 0.85rem;
        color: var(--gray);
        margin-top: 5px;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    /* Image Preview */
    .image-preview {
        display: none;
        margin-top: 15px;
        text-align: center;
    }

    .image-preview.show {
        display: block;
        animation: fadeIn 0.3s ease;
    }

    .preview-image {
        max-width: 200px;
        max-height: 200px;
        border-radius: var(--radius-md);
        border: 2px solid var(--light-gray);
        margin-bottom: 10px;
    }

    .preview-text {
        font-size: 0.85rem;
        color: var(--gray);
    }
</style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner-large"></div>
        <div class="loading-text" id="loading-text">Loading Profile...</div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div class="custom-modal" id="logout-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">
                    <i class="fas fa-sign-out-alt"></i>
                </div>
                <h2>Confirm Logout</h2>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to logout from your account?</p>
                <p style="margin-top: 10px; font-size: 0.95rem; color: var(--gray);">
                    You will need to login again to access your profile.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="modal-btn modal-btn-cancel" id="cancel-logout">
                    Cancel
                </button>
                <button type="button" class="modal-btn modal-btn-danger" id="confirm-logout">
                    Logout
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Account Confirmation Modal -->
    <div class="custom-modal" id="delete-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h2>Delete Account</h2>
            </div>
            <div class="modal-body">
                <p><strong>Warning:</strong> This action cannot be undone!</p>
                <p style="margin-top: 15px;">
                    All your data including academic records, profile information, and account details will be permanently deleted.
                </p>
                <div class="form-group" style="margin-top: 20px;">
                    <label for="confirm-password">Enter your password to confirm:</label>
                    <div class="password-container">
                        <input type="password" id="confirm-password" class="form-control" placeholder="Your password">
                        <button type="button" class="toggle-password" id="toggle-confirm-password">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="modal-btn modal-btn-cancel" id="cancel-delete">
                    Cancel
                </button>
                <button type="button" class="modal-btn modal-btn-danger" id="confirm-delete" disabled>
                    Delete Account
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <div class="profile-container">
        <div class="profile-header">
            <h1><i class="fas fa-user-circle"></i> User Profile</h1>
            <p>Manage your personal information, academic details, and account settings</p>
            <div class="user-role-badge" id="user-role-badge">
                <i class="fas fa-user-tag"></i>
                <span id="user-role-text">Loading...</span>
            </div>
        </div>
        
        <div class="profile-content">
            <!-- Profile Picture Section -->
            <div class="profile-picture-section">
                <div class="profile-picture-container">
                    <div class="profile-picture" id="profile-picture">
                        <!-- Profile picture or initials will be displayed here -->
                    </div>
                    <div class="upload-overlay" id="upload-trigger" title="Upload new profile picture">
                        <i class="fas fa-camera"></i>
                    </div>
                    <div class="upload-progress" id="upload-progress">
                        <div class="progress-circle"></div>
                        <div class="progress-text" id="progress-text">Uploading...</div>
                    </div>
                    <div class="upload-error" id="upload-error">
                        <i class="fas fa-exclamation-circle"></i>
                        <span id="upload-error-text"></span>
                    </div>
                </div>
                <input type="file" id="profile-upload" accept="image/*" hidden>
                <div class="image-preview" id="image-preview">
                    <img src="" alt="Preview" class="preview-image" id="preview-image">
                    <p class="preview-text">Image preview</p>
                </div>
                <p style="color: var(--gray); font-size: 0.9rem; margin-top: 10px; text-align: center;">
                    Click the camera icon to upload a new profile picture<br>
                    <small>Supported formats: JPG, PNG, GIF (Max 5MB)</small>
                </p>
            </div>

            <!-- Academic Information Cards -->
            <div class="academic-info-grid" id="academic-cards">
                <!-- Academic cards will be populated dynamically -->
            </div>

            <!-- Main Profile Form -->
            <form class="profile-form" id="profile-form">
                <div class="profile-info-grid">
                    <!-- Personal Information -->
                    <div class="form-section">
                        <h3><i class="fas fa-user"></i> Personal Information</h3>
                        
                        <div class="form-group">
                            <label for="profile-fullName">Full Name *</label>
                            <input type="text" id="profile-fullName" required placeholder="Enter your full name">
                            <div class="validation-message" id="name-validation"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="profile-email">Email Address *</label>
                            <input type="email" id="profile-email" required placeholder="student@ksitm.edu.ng" readonly>
                            <div class="field-disabled-text">
                                <i class="fas fa-info-circle"></i>
                                Email cannot be changed for security reasons
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="profile-phone">Phone Number *</label>
                            <input type="tel" id="profile-phone" required placeholder="+234 800 000 0000">
                            <div class="validation-message" id="phone-validation"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="profile-address">Residential Address</label>
                            <textarea id="profile-address" rows="3" placeholder="Your current address"></textarea>
                        </div>
                    </div>

                    <!-- Academic Information -->
                    <div class="form-section">
                        <h3><i class="fas fa-graduation-cap"></i> Academic Information</h3>
                        
                        <div class="form-group">
                            <label for="profile-reg-number">Registration/Staff ID *</label>
                            <input type="text" id="profile-reg-number" required readonly>
                        </div>
                        
                        <div class="form-group">
                            <label for="profile-department">Department *</label>
                            <select id="profile-department" required>
                                <option value="">Loading departments...</option>
                            </select>
                            <div class="validation-message" id="department-validation"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="profile-faculty">Faculty *</label>
                            <select id="profile-faculty" required>
                                <option value="">Loading faculties...</option>
                            </select>
                            <div class="validation-message" id="faculty-validation"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="profile-level">Academic Level/Position *</label>
                            <select id="profile-level" required>
                                <option value="">Loading levels...</option>
                            </select>
                            <div class="validation-message" id="level-validation"></div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="profile-state">State of Origin</label>
                                <input type="text" id="profile-state" placeholder="Your state">
                            </div>
                            <div class="form-group">
                                <label for="profile-lga">Local Government Area</label>
                                <input type="text" id="profile-lga" placeholder="Your LGA">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="profile-jamb">JAMB Registration Number</label>
                                <input type="text" id="profile-jamb" placeholder="JAMB number">
                            </div>
                            <div class="form-group">
                                <label for="profile-entry-year">Entry Year</label>
                                <input type="text" id="profile-entry-year" placeholder="e.g., 2023">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="form-actions">
                    <button type="button" class="cancel-btn" id="cancel-changes">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="submit" class="save-btn" id="save-changes" disabled>
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </form>

            <!-- Security Settings -->
            <div class="form-section security-section">
                <h3><i class="fas fa-shield-alt"></i> Security Settings</h3>
                <button type="button" class="toggle-password-form" id="toggle-password-form">
                    <i class="fas fa-key"></i> Change Password
                </button>
                
                <div class="password-form" id="password-form">
                    <div class="form-group">
                        <label for="current-password">Current Password *</label>
                        <div class="password-container">
                            <input type="password" id="current-password" placeholder="Enter your current password">
                            <button type="button" class="toggle-password" id="toggle-current-password">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="validation-message" id="current-password-validation"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="new-password">New Password *</label>
                        <div class="password-container">
                            <input type="password" id="new-password" placeholder="Enter new password (min. 8 characters)">
                            <button type="button" class="toggle-password" id="toggle-new-password">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        
                        <!-- Password Validation Rules -->
                        <div class="password-validation">
                            <div class="validation-title">Password must contain:</div>
                            <div class="validation-rules">
                                <div class="validation-rule" id="rule-length">
                                    <div class="rule-icon pending">
                                        <i class="fas fa-circle"></i>
                                    </div>
                                    <div class="rule-text pending">At least 8 characters</div>
                                </div>
                                <div class="validation-rule" id="rule-uppercase">
                                    <div class="rule-icon pending">
                                        <i class="fas fa-circle"></i>
                                    </div>
                                    <div class="rule-text pending">At least 1 uppercase letter (A-Z)</div>
                                </div>
                                <div class="validation-rule" id="rule-lowercase">
                                    <div class="rule-icon pending">
                                        <i class="fas fa-circle"></i>
                                    </div>
                                    <div class="rule-text pending">At least 1 lowercase letter (a-z)</div>
                                </div>
                                <div class="validation-rule" id="rule-number">
                                    <div class="rule-icon pending">
                                        <i class="fas fa-circle"></i>
                                    </div>
                                    <div class="rule-text pending">At least 1 number (0-9)</div>
                                </div>
                                <div class="validation-rule" id="rule-special">
                                    <div class="rule-icon pending">
                                        <i class="fas fa-circle"></i>
                                    </div>
                                    <div class="rule-text pending">At least 1 special character (!@#$%^&*)</div>
                                </div>
                                <div class="validation-rule" id="rule-match">
                                    <div class="rule-icon pending">
                                        <i class="fas fa-circle"></i>
                                    </div>
                                    <div class="rule-text pending">Passwords must match</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="confirm-new-password">Confirm New Password *</label>
                        <div class="password-container">
                            <input type="password" id="confirm-new-password" placeholder="Confirm new password">
                            <button type="button" class="toggle-password" id="toggle-confirm-new-password">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="validation-message" id="password-match-validation"></div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="cancel-btn" id="cancel-password">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="button" class="auth-btn" id="change-password-btn" disabled>
                            <i class="fas fa-key"></i> Change Password
                        </button>
                    </div>
                </div>
            </div>

            <!-- Danger Zone -->
            <div class="danger-zone">
                <h3><i class="fas fa-exclamation-triangle"></i> Account Management</h3>
                <p>These actions are permanent and cannot be undone. Please proceed with caution.</p>
                
                <div class="danger-actions">
                    <button type="button" class="logout-btn" id="logout-btn">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                    
                    <button type="button" class="delete-account-btn" id="delete-account-btn">
                        <i class="fas fa-trash-alt"></i> Delete Account
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Include the consolidated school app JS -->
    <script src="js/school-app.js"></script>
    
    <!-- Profile Manager Script -->
<script>
    // Profile page specific functions
    let originalProfileData = {};
    let hasChanges = false;
    let unsubscribeProfile = null;
    let currentUserData = null;
    let schoolConfig = null;
    let uploadTimeout = null;
    const UPLOAD_TIMEOUT_DURATION = 30000; // 30 seconds timeout

    // Page-specific authentication functions
    const ProfileManager = {
        currentUser: null,
        userData: null,

        initialize: async function() {
            return new Promise((resolve, reject) => {
                firebase.auth().onAuthStateChanged(async (user) => {
                    if (user) {
                        this.currentUser = user;
                        await this.loadUserData(user.uid);
                        resolve(user);
                    } else {
                        this.currentUser = null;
                        this.userData = null;
                        resolve(null);
                    }
                });
            });
        },

        loadUserData: async function(uid) {
            try {
                const doc = await firebase.firestore().collection('users').doc(uid).get();
                if (doc.exists) {
                    this.userData = { uid, ...doc.data() };
                    currentUserData = this.userData;
                    localStorage.setItem('currentUser', JSON.stringify(this.userData));
                    return this.userData;
                }
                return null;
            } catch (error) {
                console.error("Error loading user data:", error);
                showToast('Error loading profile data', 'error');
                return null;
            }
        },

        getCurrentUser: function() {
            return this.currentUser;
        },

        getUserData: function() {
            return this.userData;
        },

        updateProfile: async function(uid, profileData) {
            try {
                const updateData = {
                    ...profileData,
                    updatedAt: new Date().toISOString()
                };
                
                await firebase.firestore().collection('users').doc(uid).update(updateData);
                return { success: true };
            } catch (error) {
                return { success: false, error: error.message };
            }
        },

        changePassword: async function(currentPassword, newPassword) {
            try {
                const user = this.currentUser;
                const credential = firebase.auth.EmailAuthProvider.credential(
                    user.email, 
                    currentPassword
                );
                
                await user.reauthenticateWithCredential(credential);
                await user.updatePassword(newPassword);
                return { success: true };
            } catch (error) {
                let errorMessage = 'Password change failed';
                switch (error.code) {
                    case 'auth/wrong-password':
                        errorMessage = 'Current password is incorrect';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'Password is too weak';
                        break;
                    case 'auth/requires-recent-login':
                        errorMessage = 'Please login again to change password';
                        break;
                    default:
                        errorMessage = error.message;
                }
                return { success: false, error: errorMessage };
            }
        },

        deleteAccount: async function(password) {
            try {
                const user = this.currentUser;
                if (!user) return { success: false, error: 'No user logged in' };
                
                // Reauthenticate user
                const credential = firebase.auth.EmailAuthProvider.credential(user.email, password);
                await user.reauthenticateWithCredential(credential);
                
                // Delete from Firestore
                await firebase.firestore().collection('users').doc(user.uid).delete();
                
                // Delete profile image from storage if exists
                try {
                    if (userData && userData.profilePicture) {
                        // Extract the path from the URL or use default path
                        const storageRef = firebase.storage().ref();
                        const imageRef = storageRef.child(`profile_images/${user.uid}`);
                        await imageRef.listAll().then(list => {
                            list.items.forEach(item => item.delete());
                        });
                    }
                } catch (storageError) {
                    console.warn('Error deleting profile images:', storageError);
                }
                
                // Delete user from Auth
                await user.delete();
                
                this.currentUser = null;
                this.userData = null;
                localStorage.removeItem('currentUser');
                
                return { success: true };
            } catch (error) {
                let errorMessage = 'Account deletion failed';
                switch (error.code) {
                    case 'auth/wrong-password':
                        errorMessage = 'Incorrect password';
                        break;
                    case 'auth/requires-recent-login':
                        errorMessage = 'Please login again to delete account';
                        break;
                    default:
                        errorMessage = error.message;
                }
                return { success: false, error: errorMessage };
            }
        },

        logout: async function() {
            try {
                await firebase.auth().signOut();
                this.currentUser = null;
                this.userData = null;
                localStorage.removeItem('currentUser');
                return { success: true };
            } catch (error) {
                return { success: false, error: error.message };
            }
        },

        uploadProfileImage: async function(file, uid) {
            return new Promise(async (resolve, reject) => {
                try {
                    // Create unique filename
                    const timestamp = Date.now();
                    const fileExtension = file.name.split('.').pop();
                    const fileName = `profile_${timestamp}.${fileExtension}`;
                    
                    // Create storage reference
                    const storageRef = firebase.storage().ref();
                    const imageRef = storageRef.child(`profile_images/${uid}/${fileName}`);
                    
                    // Set metadata for the file
                    const metadata = {
                        contentType: file.type,
                        customMetadata: {
                            'uploadedBy': uid,
                            'uploadedAt': new Date().toISOString(),
                            'originalName': file.name
                        }
                    };
                    
                    // Start upload
                    const uploadTask = imageRef.put(file, metadata);
                    
                    // Set upload timeout
                    uploadTimeout = setTimeout(() => {
                        uploadTask.cancel();
                        reject(new Error('Upload timeout. Please try again.'));
                        hideUploadProgress();
                        showUploadError('Upload timed out after 30 seconds. Please try again.');
                    }, UPLOAD_TIMEOUT_DURATION);
                    
                    uploadTask.on('state_changed',
                        (snapshot) => {
                            // Clear timeout on progress
                            clearTimeout(uploadTimeout);
                            uploadTimeout = setTimeout(() => {
                                uploadTask.cancel();
                                reject(new Error('Upload timeout. Please try again.'));
                                hideUploadProgress();
                                showUploadError('Upload timed out. Please try again.');
                            }, UPLOAD_TIMEOUT_DURATION);
                            
                            // Progress tracking
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            updateUploadProgress(progress, snapshot.state);
                        },
                        (error) => {
                            clearTimeout(uploadTimeout);
                            hideUploadProgress();
                            
                            let errorMessage = 'Upload failed';
                            switch (error.code) {
                                case 'storage/unauthorized':
                                    errorMessage = 'You do not have permission to upload';
                                    break;
                                case 'storage/canceled':
                                    errorMessage = 'Upload was cancelled';
                                    break;
                                case 'storage/unknown':
                                    errorMessage = 'Unknown error occurred';
                                    break;
                                case 'storage/quota-exceeded':
                                    errorMessage = 'Storage quota exceeded';
                                    break;
                                default:
                                    errorMessage = error.message;
                            }
                            
                            showUploadError(errorMessage);
                            reject(new Error(errorMessage));
                        },
                        async () => {
                            clearTimeout(uploadTimeout);
                            
                            try {
                                // Get download URL
                                const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                                
                                // Update user profile in Firestore
                                await firebase.firestore().collection('users').doc(uid).update({
                                    profilePicture: downloadURL,
                                    updatedAt: new Date().toISOString()
                                });
                                
                                // Update local data
                                if (currentUserData) {
                                    currentUserData.profilePicture = downloadURL;
                                    ProfileManager.userData = currentUserData;
                                }
                                
                                // Clean up old profile images (keep only the latest 3)
                                await cleanupOldProfileImages(uid);
                                
                                hideUploadProgress();
                                resolve(downloadURL);
                            } catch (dbError) {
                                hideUploadProgress();
                                showUploadError('Failed to update profile: ' + dbError.message);
                                reject(dbError);
                            }
                        }
                    );
                } catch (error) {
                    clearTimeout(uploadTimeout);
                    hideUploadProgress();
                    showUploadError('Upload failed: ' + error.message);
                    reject(error);
                }
            });
        }
    };

    // DOM Ready
    document.addEventListener('DOMContentLoaded', async function() {
        await initializeProfile();
        setupEventListeners();
    });

    async function initializeProfile() {
        try {
            showLoading('Loading profile...');
            
            // Initialize auth and load user data
            await ProfileManager.initialize();
            
            if (!ProfileManager.currentUser) {
                window.location.href = 'login.html';
                return;
            }
            
            // Load school configuration
            await loadSchoolConfig();
            
            // Load initial profile data
            await loadProfileData();
            
            // Setup realtime listener for profile updates
            setupRealtimeProfileListener();
            
            showToast('Profile loaded successfully', 'success');
        } catch (error) {
            console.error('Initialization error:', error);
            showToast('Error loading profile: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    async function loadSchoolConfig() {
        try {
            const doc = await firebase.firestore().collection('schoolConfig').doc('main').get();
            if (doc.exists) {
                schoolConfig = doc.data();
                
                // Populate dropdowns
                populateDropdown('profile-department', schoolConfig.departments || []);
                populateDropdown('profile-faculty', schoolConfig.faculties || []);
                
                // Populate levels based on user role
                const userData = ProfileManager.getUserData();
                const userRole = userData?.role?.toLowerCase() || '';
                
                if (userRole.includes('student')) {
                    populateDropdown('profile-level', schoolConfig.academicLevels || getDefaultStudentLevels());
                } else if (userRole.includes('lecturer') || userRole.includes('professor') || userRole.includes('hod') || userRole.includes('dean')) {
                    populateDropdown('profile-level', schoolConfig.lecturerPositions || getDefaultLecturerPositions());
                } else {
                    // Default to academic levels
                    populateDropdown('profile-level', schoolConfig.academicLevels || getDefaultStudentLevels());
                }
            } else {
                // Use default values if config not found
                populateDefaultDropdowns();
            }
        } catch (error) {
            console.error('Error loading school config:', error);
            populateDefaultDropdowns();
        }
    }

    function getDefaultStudentLevels() {
        return ['100 Level', '200 Level', '300 Level', '400 Level', '500 Level'];
    }

    function getDefaultLecturerPositions() {
        return ['Lecturer I', 'Lecturer II', 'Senior Lecturer', 'Associate Professor', 'Professor', 'Head of Department', 'Dean'];
    }

    function populateDefaultDropdowns() {
        populateDropdown('profile-department', ['Computer Science', 'Electrical Engineering', 'Mechanical Engineering', 'Civil Engineering']);
        populateDropdown('profile-faculty', ['Engineering', 'Sciences', 'Social Sciences', 'Management Sciences']);
        populateDropdown('profile-level', getDefaultStudentLevels());
    }

    function populateDropdown(selectId, items) {
        const select = document.getElementById(selectId);
        if (!select) return;
        
        // Clear existing options except the first
        while (select.options.length > 0) {
            select.remove(0);
        }
        
        // Add default option
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = items && items.length > 0 ? 'Select an option...' : 'No options available';
        defaultOption.disabled = true;
        defaultOption.selected = true;
        select.appendChild(defaultOption);
        
        // Add new options
        if (items && items.length > 0) {
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.textContent = item;
                select.appendChild(option);
            });
        }
    }

    function setupRealtimeProfileListener() {
        const uid = ProfileManager.currentUser.uid;
        
        unsubscribeProfile = firebase.firestore().collection('users').doc(uid)
            .onSnapshot(async (snapshot) => {
                if (snapshot.exists) {
                    const updatedData = snapshot.data();
                    currentUserData = { uid, ...updatedData };
                    
                    // Update UI with realtime data
                    updateProfileDisplay(updatedData);
                    
                    // Check for changes
                    checkForChanges();
                }
            }, (error) => {
                console.error('Realtime listener error:', error);
                showToast('Error receiving updates', 'error');
            });
    }

    async function loadProfileData() {
        try {
            const userData = ProfileManager.getUserData();
            
            if (!userData) {
                showToast('Error loading profile data', 'error');
                return;
            }
            
            originalProfileData = { ...userData };
            currentUserData = userData;
            
            // Populate form fields
            populateFormFields(userData);
            
            // Update display elements
            updateProfileDisplay(userData);
            
            // Load profile picture
            await loadProfilePicture(userData);
            
        } catch (error) {
            console.error('Error loading profile:', error);
            showToast('Error loading profile data', 'error');
        }
    }

    function populateFormFields(userData) {
        // Set form values
        setFormValue('profile-fullName', userData.fullName || '');
        setFormValue('profile-reg-number', userData.regNumber || userData.staffId || '');
        setFormValue('profile-email', userData.email || '');
        setFormValue('profile-phone', userData.phone || '');
        setFormValue('profile-state', userData.state || '');
        setFormValue('profile-lga', userData.lga || '');
        setFormValue('profile-address', userData.address || '');
        setFormValue('profile-jamb', userData.jambNumber || '');
        setFormValue('profile-entry-year', userData.entryYear || '');
        
        // Set dropdown values (delay to ensure dropdowns are populated)
        setTimeout(() => {
            if (userData.department) {
                setDropdownValue('profile-department', userData.department);
            }
            if (userData.faculty) {
                setDropdownValue('profile-faculty', userData.faculty);
            }
            if (userData.level || userData.position) {
                setDropdownValue('profile-level', userData.level || userData.position);
            }
        }, 100);
        
        // Set role badge
        const role = userData.role || 'User';
        document.getElementById('user-role-text').textContent = role;
        
        // Set role-specific styling
        const roleBadge = document.getElementById('user-role-badge');
        roleBadge.className = 'user-role-badge';
        if (role.toLowerCase().includes('admin')) {
            roleBadge.style.backgroundColor = 'rgba(67, 97, 238, 0.3)';
        } else if (role.toLowerCase().includes('lecturer') || role.toLowerCase().includes('professor')) {
            roleBadge.style.backgroundColor = 'rgba(52, 152, 219, 0.3)';
        } else if (role.toLowerCase().includes('student')) {
            roleBadge.style.backgroundColor = 'rgba(46, 204, 113, 0.3)';
        }
    }

    function setDropdownValue(selectId, value) {
        const select = document.getElementById(selectId);
        if (select && value) {
            for (let i = 0; i < select.options.length; i++) {
                if (select.options[i].value === value) {
                    select.selectedIndex = i;
                    break;
                }
            }
        }
    }

    function updateProfileDisplay(userData) {
        // Update academic cards
        updateAcademicCards(userData);
        
        // Update form fields if they're not being edited
        if (!hasChanges) {
            populateFormFields(userData);
        }
    }

    function updateAcademicCards(userData) {
        const cardsContainer = document.getElementById('academic-cards');
        
        const cardsData = [
            {
                icon: 'fas fa-id-card',
                label: 'Registration ID',
                value: userData.regNumber || userData.staffId || 'N/A',
                color: 'var(--primary)'
            },
            {
                icon: 'fas fa-building',
                label: 'Department',
                value: userData.department || 'N/A',
                color: 'var(--info)'
            },
            {
                icon: 'fas fa-university',
                label: 'Faculty',
                value: userData.faculty || 'N/A',
                color: 'var(--warning)'
            },
            {
                icon: 'fas fa-graduation-cap',
                label: userData.role && userData.role.toLowerCase().includes('student') ? 'Academic Level' : 'Position',
                value: userData.level || userData.position || 'N/A',
                color: 'var(--success)'
            },
            {
                icon: 'fas fa-chart-line',
                label: 'CGPA/Score',
                value: userData.cgpa || userData.score || 'N/A',
                color: '#27ae60',
                isCgpa: true
            },
            {
                icon: 'fas fa-check-circle',
                label: 'Status',
                value: userData.status || 'Active',
                color: userData.status === 'Active' ? '#27ae60' : 
                       userData.status === 'Inactive' ? '#e74c3c' : '#f39c12',
                statusClass: `status-${(userData.status || 'active').toLowerCase()}`
            }
        ];
        
        let cardsHTML = '';
        cardsData.forEach(card => {
            const valueClass = card.isCgpa ? 'cgpa' : card.statusClass || '';
            cardsHTML += `
                <div class="academic-card">
                    <div class="info-label">
                        <i class="${card.icon}" style="color: ${card.color}"></i>
                        ${card.label}
                    </div>
                    <div class="info-value ${valueClass}">
                        ${card.value}
                    </div>
                </div>
            `;
        });
        
        cardsContainer.innerHTML = cardsHTML;
    }

    async function loadProfilePicture(userData) {
        const profilePicture = document.getElementById('profile-picture');
        if (!profilePicture) return;
        
        // Clear current content
        profilePicture.innerHTML = '';
        
        // Check for profile picture URL
        if (userData.profilePicture) {
            const img = document.createElement('img');
            img.src = userData.profilePicture + '?t=' + Date.now(); // Cache busting
            img.alt = 'Profile Picture';
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.borderRadius = '50%';
            img.style.objectFit = 'cover';
            
            // Handle image loading errors
            img.onerror = () => {
                showInitials(userData.fullName, userData.role);
            };
            
            img.onload = () => {
                profilePicture.appendChild(img);
            };
            
            // Fallback if image doesn't load quickly
            setTimeout(() => {
                if (!profilePicture.hasChildNodes()) {
                    showInitials(userData.fullName, userData.role);
                }
            }, 2000);
            
        } else {
            showInitials(userData.fullName, userData.role);
        }
    }

    function showInitials(fullName, role) {
        const profilePicture = document.getElementById('profile-picture');
        if (!profilePicture) return;
        
        const names = fullName ? fullName.split(' ') : ['U', 'S'];
        const initials = names[0].charAt(0) + (names.length > 1 ? names[names.length - 1].charAt(0) : names[0].charAt(1) || '');
        
        profilePicture.innerHTML = initials.toUpperCase();
        profilePicture.style.display = 'flex';
        profilePicture.style.alignItems = 'center';
        profilePicture.style.justifyContent = 'center';
        profilePicture.style.fontSize = '3rem';
        profilePicture.style.fontWeight = 'bold';
        
        // Set background based on role
        let bgColor = '#920f09f3'; // Default primary color
        if (role) {
            if (role.toLowerCase().includes('admin')) {
                bgColor = '#4361ee';
            } else if (role.toLowerCase().includes('lecturer') || role.toLowerCase().includes('professor')) {
                bgColor = '#3498db';
            } else if (role.toLowerCase().includes('student')) {
                bgColor = '#2ecc71';
            }
        }
        profilePicture.style.backgroundColor = bgColor;
        profilePicture.style.color = 'white';
    }

    function setFormValue(elementId, value) {
        const element = document.getElementById(elementId);
        if (element) {
            element.value = value || '';
        }
    }

    function setupEventListeners() {
        // Profile form submission
        const profileForm = document.getElementById('profile-form');
        if (profileForm) {
            profileForm.addEventListener('submit', handleProfileSubmit);
        }
        
        // Form input change detection
        document.querySelectorAll('#profile-form input:not([readonly]):not([disabled]), #profile-form textarea, #profile-form select').forEach(input => {
            input.addEventListener('input', () => {
                checkForChanges();
                validateField(input);
            });
            
            input.addEventListener('blur', () => validateField(input));
        });
        
        // Cancel changes button
        document.getElementById('cancel-changes').addEventListener('click', resetForm);
        
        // Password change
        document.getElementById('change-password-btn').addEventListener('click', handlePasswordChange);
        document.getElementById('toggle-password-form').addEventListener('click', togglePasswordForm);
        document.getElementById('cancel-password').addEventListener('click', togglePasswordForm);
        
        // Password field validation
        document.getElementById('new-password').addEventListener('input', validatePassword);
        document.getElementById('confirm-new-password').addEventListener('input', validatePasswordMatch);
        document.getElementById('current-password').addEventListener('input', validateCurrentPassword);
        
        // Toggle password visibility
        document.querySelectorAll('.toggle-password').forEach(button => {
            button.addEventListener('click', function() {
                const input = this.parentElement.querySelector('input');
                togglePasswordVisibility(input, this);
            });
        });
        
        // Confirm password toggle
        document.getElementById('toggle-confirm-password').addEventListener('click', function() {
            const input = document.getElementById('confirm-password');
            togglePasswordVisibility(input, this);
        });
        
        // Logout and delete buttons
        document.getElementById('logout-btn').addEventListener('click', () => showModal('logout'));
        document.getElementById('delete-account-btn').addEventListener('click', () => showModal('delete'));
        
        // Modal buttons
        document.getElementById('cancel-logout').addEventListener('click', () => hideModal('logout'));
        document.getElementById('confirm-logout').addEventListener('click', handleLogout);
        document.getElementById('cancel-delete').addEventListener('click', () => hideModal('delete'));
        document.getElementById('confirm-delete').addEventListener('click', handleDeleteAccount);
        document.getElementById('confirm-password').addEventListener('input', validateDeleteForm);
        
        // Profile picture upload
        document.getElementById('upload-trigger').addEventListener('click', () => document.getElementById('profile-upload').click());
        document.getElementById('profile-upload').addEventListener('change', handleProfilePictureUpload);
        
        // Email field - prevent changes
        const emailField = document.getElementById('profile-email');
        if (emailField) {
            emailField.addEventListener('focus', (e) => {
                e.preventDefault();
                emailField.blur();
                showToast('Email cannot be changed for security reasons', 'info');
            });
            
            emailField.addEventListener('click', (e) => {
                e.preventDefault();
                showToast('Email cannot be changed for security reasons', 'info');
            });
        }
    }

    function validateField(field) {
        const fieldId = field.id;
        const value = field.value.trim();
        const validationElement = document.getElementById(`${fieldId}-validation`);
        
        if (!validationElement) return true;
        
        // Clear previous validation
        field.classList.remove('valid', 'invalid');
        validationElement.textContent = '';
        validationElement.className = 'validation-message';
        
        // Skip validation for empty optional fields
        if (!field.required && !value) {
            return true;
        }
        
        // Field-specific validation
        let isValid = true;
        let message = '';
        
        switch(fieldId) {
            case 'profile-fullName':
                if (!value) {
                    isValid = false;
                    message = 'Full name is required';
                } else if (value.length < 2) {
                    isValid = false;
                    message = 'Name is too short';
                } else if (value.length > 100) {
                    isValid = false;
                    message = 'Name is too long';
                }
                break;
                
            case 'profile-phone':
                if (!value) {
                    isValid = false;
                    message = 'Phone number is required';
                } else if (!window.SchoolApp.SchoolUtils.validatePhone(value)) {
                    isValid = false;
                    message = 'Invalid phone number format';
                }
                break;
                
            case 'profile-department':
            case 'profile-faculty':
            case 'profile-level':
                if (!value) {
                    isValid = false;
                    message = 'This field is required';
                }
                break;
                
            case 'profile-jamb':
                if (value && !/^[0-9]{8}[A-Z]{2}$/i.test(value)) {
                    isValid = false;
                    message = 'Invalid JAMB number format (e.g., 12345678AB)';
                }
                break;
                
            case 'profile-entry-year':
                if (value && !/^(19|20)\d{2}$/.test(value)) {
                    isValid = false;
                    message = 'Invalid year format (e.g., 2023)';
                }
                break;
        }
        
        // Update UI
        if (isValid && value) {
            field.classList.add('valid');
            validationElement.textContent = ' Valid';
            validationElement.classList.add('valid');
        } else if (!isValid) {
            field.classList.add('invalid');
            validationElement.textContent = message;
            validationElement.classList.add('invalid');
        }
        
        return isValid;
    }

    function validateCurrentPassword() {
        const currentPass = document.getElementById('current-password').value;
        const validationElement = document.getElementById('current-password-validation');
        
        if (!currentPass) {
            validationElement.textContent = '';
            validationElement.className = 'validation-message';
            validatePasswordForm();
            return;
        }
        
        if (currentPass.length < 6) {
            validationElement.textContent = 'Password is too short';
            validationElement.className = 'validation-message invalid';
        } else {
            validationElement.textContent = ' Valid';
            validationElement.className = 'validation-message valid';
        }
        
        validatePasswordForm();
    }

    function validatePassword() {
        const password = document.getElementById('new-password').value;
        
        // Validate length
        const lengthValid = password.length >= 8;
        updateValidationRule('length', lengthValid);
        
        // Validate uppercase
        const uppercaseValid = /[A-Z]/.test(password);
        updateValidationRule('uppercase', uppercaseValid);
        
        // Validate lowercase
        const lowercaseValid = /[a-z]/.test(password);
        updateValidationRule('lowercase', lowercaseValid);
        
        // Validate number
        const numberValid = /[0-9]/.test(password);
        updateValidationRule('number', numberValid);
        
        // Validate special character
        const specialValid = /[!@#$%^&*]/.test(password);
        updateValidationRule('special', specialValid);
        
        // Validate match (if confirm password is filled)
        if (document.getElementById('confirm-new-password').value) {
            validatePasswordMatch();
        }
        
        validatePasswordForm();
    }

    function validatePasswordMatch() {
        const password = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-new-password').value;
        const matchValid = password === confirmPassword && password.length > 0;
        const validationElement = document.getElementById('password-match-validation');
        
        updateValidationRule('match', matchValid);
        
        if (password && confirmPassword) {
            if (matchValid) {
                validationElement.textContent = ' Passwords match';
                validationElement.className = 'validation-message valid';
            } else {
                validationElement.textContent = ' Passwords do not match';
                validationElement.className = 'validation-message invalid';
            }
        } else {
            validationElement.textContent = '';
            validationElement.className = 'validation-message';
        }
        
        validatePasswordForm();
    }

    function updateValidationRule(ruleId, isValid) {
        const ruleElement = document.getElementById(`rule-${ruleId}`);
        if (!ruleElement) return;
        
        const iconElement = ruleElement.querySelector('.rule-icon');
        const textElement = ruleElement.querySelector('.rule-text');
        
        if (isValid) {
            iconElement.className = 'rule-icon valid';
            iconElement.innerHTML = '<i class="fas fa-check"></i>';
            textElement.className = 'rule-text valid';
        } else {
            iconElement.className = 'rule-icon invalid';
            iconElement.innerHTML = '<i class="fas fa-times"></i>';
            textElement.className = 'rule-text invalid';
        }
    }

    function validatePasswordForm() {
        const currentPass = document.getElementById('current-password').value;
        const newPass = document.getElementById('new-password').value;
        const confirmPass = document.getElementById('confirm-new-password').value;
        const changeBtn = document.getElementById('change-password-btn');
        
        // Check all password rules
        const lengthValid = newPass.length >= 8;
        const uppercaseValid = /[A-Z]/.test(newPass);
        const lowercaseValid = /[a-z]/.test(newPass);
        const numberValid = /[0-9]/.test(newPass);
        const specialValid = /[!@#$%^&*]/.test(newPass);
        const matchValid = newPass === confirmPass;
        
        const isValid = currentPass && newPass && confirmPass && 
                       lengthValid && uppercaseValid && lowercaseValid && 
                       numberValid && specialValid && matchValid;
        
        changeBtn.disabled = !isValid;
    }

    function validateDeleteForm() {
        const password = document.getElementById('confirm-password').value;
        const deleteBtn = document.getElementById('confirm-delete');
        
        deleteBtn.disabled = !password;
    }

    function checkForChanges() {
        if (!currentUserData) return;
        
        const formData = getFormData();
        hasChanges = false;
        
        // Check each field for changes
        const fieldsToCheck = ['fullName', 'phone', 'department', 'faculty', 'level', 'state', 'lga', 'address', 'jambNumber', 'entryYear'];
        
        for (const field of fieldsToCheck) {
            const formField = field === 'level' ? 'profile-level' : 
                            field === 'jambNumber' ? 'profile-jamb' :
                            field === 'entryYear' ? 'profile-entry-year' :
                            `profile-${field}`;
            
            let formValue = '';
            const formElement = document.getElementById(formField);
            if (formElement) {
                formValue = formElement.value.trim();
            }
            
            const originalValue = currentUserData[field] || '';
            
            if (formValue !== originalValue) {
                hasChanges = true;
                break;
            }
        }
        
        const saveBtn = document.getElementById('save-changes');
        saveBtn.disabled = !hasChanges;
        
        // Update save button text
        if (hasChanges) {
            saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
        }
    }

    function getFormData() {
        return {
            fullName: document.getElementById('profile-fullName').value.trim(),
            phone: document.getElementById('profile-phone').value.trim(),
            department: document.getElementById('profile-department').value,
            faculty: document.getElementById('profile-faculty').value,
            level: document.getElementById('profile-level').value,
            state: document.getElementById('profile-state').value.trim(),
            lga: document.getElementById('profile-lga').value.trim(),
            address: document.getElementById('profile-address').value.trim(),
            jambNumber: document.getElementById('profile-jamb').value.trim(),
            entryYear: document.getElementById('profile-entry-year').value.trim()
        };
    }

    async function handleProfileSubmit(e) {
        e.preventDefault();
        
        if (!hasChanges) {
            showToast('No changes to save', 'info');
            return;
        }
        
        try {
            showLoading('Saving changes...');
            
            const formData = getFormData();
            
            // Validate required fields
            const requiredFields = [
                { field: 'fullName', name: 'Full name' },
                { field: 'phone', name: 'Phone number' },
                { field: 'department', name: 'Department' },
                { field: 'faculty', name: 'Faculty' },
                { field: 'level', name: 'Academic level/Position' }
            ];
            
            for (const req of requiredFields) {
                if (!formData[req.field]) {
                    throw new Error(`${req.name} is required`);
                }
            }
            
            if (!window.SchoolApp.SchoolUtils.validatePhone(formData.phone)) {
                throw new Error('Please enter a valid phone number');
            }
            
            const result = await ProfileManager.updateProfile(
                ProfileManager.currentUser.uid,
                formData
            );
            
            if (result.success) {
                showToast('Profile updated successfully', 'success');
                originalProfileData = { ...currentUserData, ...formData };
                hasChanges = false;
                document.getElementById('save-changes').disabled = true;
                document.getElementById('save-changes').innerHTML = '<i class="fas fa-check"></i> Saved';
                
                // Reset button text after 2 seconds
                setTimeout(() => {
                    document.getElementById('save-changes').innerHTML = '<i class="fas fa-save"></i> Save Changes';
                }, 2000);
            } else {
                throw new Error(result.error || 'Failed to update profile');
            }
        } catch (error) {
            showToast('Error saving changes: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    function resetForm() {
        if (!hasChanges) {
            showToast('No changes to discard', 'info');
            return;
        }
        
        if (confirm('Are you sure you want to discard your changes?')) {
            populateFormFields(currentUserData);
            hasChanges = false;
            document.getElementById('save-changes').disabled = true;
            showToast('Changes discarded', 'info');
        }
    }

    async function handlePasswordChange() {
        const currentPassword = document.getElementById('current-password').value;
        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-new-password').value;
        
        // Final validation
        if (!currentPassword || !newPassword || !confirmPassword) {
            showToast('Please fill in all password fields', 'error');
            return;
        }
        
        if (newPassword !== confirmPassword) {
            showToast('New passwords do not match', 'error');
            return;
        }
        
        // Check password strength
        const lengthValid = newPassword.length >= 8;
        const uppercaseValid = /[A-Z]/.test(newPassword);
        const lowercaseValid = /[a-z]/.test(newPassword);
        const numberValid = /[0-9]/.test(newPassword);
        const specialValid = /[!@#$%^&*]/.test(newPassword);
        
        if (!lengthValid || !uppercaseValid || !lowercaseValid || !numberValid || !specialValid) {
            showToast('Please ensure new password meets all requirements', 'error');
            return;
        }
        
        try {
            showLoading('Changing password...');
            
            const result = await ProfileManager.changePassword(currentPassword, newPassword);
            
            if (result.success) {
                showToast('Password changed successfully', 'success');
                
                // Clear password fields
                document.getElementById('current-password').value = '';
                document.getElementById('new-password').value = '';
                document.getElementById('confirm-new-password').value = '';
                
                // Reset validation rules
                resetPasswordValidationRules();
                
                // Hide password form
                togglePasswordForm();
                
            } else {
                throw new Error(result.error || 'Failed to change password');
            }
        } catch (error) {
            showToast('Error changing password: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    function resetPasswordValidationRules() {
        const rules = ['length', 'uppercase', 'lowercase', 'number', 'special', 'match'];
        rules.forEach(ruleId => {
            const ruleElement = document.getElementById(`rule-${ruleId}`);
            if (ruleElement) {
                const iconElement = ruleElement.querySelector('.rule-icon');
                const textElement = ruleElement.querySelector('.rule-text');
                iconElement.className = 'rule-icon pending';
                iconElement.innerHTML = '<i class="fas fa-circle"></i>';
                textElement.className = 'rule-text pending';
            }
        });
        
        // Clear validation messages
        document.getElementById('current-password-validation').textContent = '';
        document.getElementById('password-match-validation').textContent = '';
    }

    async function handleProfilePictureUpload(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        // Validate file
        if (!file.type.startsWith('image/')) {
            showUploadError('Please select an image file (JPG, PNG, GIF)');
            return;
        }
        
        if (file.size > 5 * 1024 * 1024) {
            showUploadError('Image size should be less than 5MB');
            return;
        }
        
        try {
            // Show image preview
            const reader = new FileReader();
            reader.onload = (event) => {
                const previewImage = document.getElementById('preview-image');
                const previewContainer = document.getElementById('image-preview');
                
                previewImage.src = event.target.result;
                previewContainer.classList.add('show');
            };
            reader.readAsDataURL(file);
            
            // Show upload progress
            showUploadProgress();
            
            // Upload image
            const downloadURL = await ProfileManager.uploadProfileImage(file, ProfileManager.currentUser.uid);
            
            // Update profile picture display
            await loadProfilePicture({...currentUserData, profilePicture: downloadURL});
            
            showToast('Profile picture updated successfully', 'success');
            
            // Hide preview after successful upload
            setTimeout(() => {
                document.getElementById('image-preview').classList.remove('show');
            }, 2000);
            
        } catch (error) {
            console.error('Upload error:', error);
            // Error is already shown by the upload function
        } finally {
            // Clear file input
            document.getElementById('profile-upload').value = '';
        }
    }

    async function cleanupOldProfileImages(uid) {
        try {
            const storageRef = firebase.storage().ref();
            const profileFolderRef = storageRef.child(`profile_images/${uid}`);
            
            const listResult = await profileFolderRef.listAll();
            
            // Sort files by timestamp (newest first)
            const files = await Promise.all(
                listResult.items.map(async (item) => {
                    const metadata = await item.getMetadata();
                    return {
                        ref: item,
                        timeCreated: new Date(metadata.timeCreated),
                        name: item.name
                    };
                })
            );
            
            // Sort by creation time (newest first)
            files.sort((a, b) => b.timeCreated - a.timeCreated);
            
            // Delete all but the 3 most recent files
            for (let i = 3; i < files.length; i++) {
                try {
                    await files[i].ref.delete();
                    console.log(`Deleted old profile image: ${files[i].name}`);
                } catch (deleteError) {
                    console.warn(`Failed to delete old image ${files[i].name}:`, deleteError);
                }
            }
        } catch (error) {
            console.warn('Error cleaning up old profile images:', error);
        }
    }

    function showUploadProgress() {
        const progressElement = document.getElementById('upload-progress');
        progressElement.classList.add('active');
        hideUploadError();
    }

    function hideUploadProgress() {
        const progressElement = document.getElementById('upload-progress');
        progressElement.classList.remove('active');
    }

    function updateUploadProgress(progress, state = 'running') {
        const progressText = document.getElementById('progress-text');
        let text = 'Uploading...';
        
        if (state === 'running') {
            text = `Uploading... ${Math.round(progress)}%`;
        } else if (state === 'paused') {
            text = 'Upload paused';
        }
        
        progressText.textContent = text;
    }

    function showUploadError(message) {
        const errorElement = document.getElementById('upload-error');
        const errorText = document.getElementById('upload-error-text');
        
        errorText.textContent = message;
        errorElement.classList.add('show');
        
        // Auto-hide error after 10 seconds
        setTimeout(() => {
            hideUploadError();
        }, 10000);
    }

    function hideUploadError() {
        const errorElement = document.getElementById('upload-error');
        errorElement.classList.remove('show');
    }

    async function handleLogout() {
        try {
            hideModal('logout');
            showLoading('Logging out...');
            
            const result = await ProfileManager.logout();
            
            if (result.success) {
                showToast('Logged out successfully', 'success');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 1000);
            } else {
                throw new Error(result.error || 'Failed to logout');
            }
        } catch (error) {
            showToast('Error logging out: ' + error.message, 'error');
            hideLoading();
        }
    }

    async function handleDeleteAccount() {
        const password = document.getElementById('confirm-password').value;
        
        if (!password) {
            showToast('Please enter your password', 'error');
            return;
        }
        
        try {
            hideModal('delete');
            showLoading('Deleting account...');
            
            const result = await ProfileManager.deleteAccount(password);
            
            if (result.success) {
                showToast('Account deleted successfully', 'success');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
            } else {
                throw new Error(result.error || 'Failed to delete account');
            }
        } catch (error) {
            showToast('Error deleting account: ' + error.message, 'error');
            hideLoading();
            
            // Clear password field
            document.getElementById('confirm-password').value = '';
            document.getElementById('confirm-delete').disabled = true;
        }
    }

    function togglePasswordForm() {
        const passwordForm = document.getElementById('password-form');
        const toggleBtn = document.getElementById('toggle-password-form');
        
        passwordForm.classList.toggle('active');
        
        if (passwordForm.classList.contains('active')) {
            toggleBtn.innerHTML = '<i class="fas fa-times"></i> Cancel Password Change';
        } else {
            toggleBtn.innerHTML = '<i class="fas fa-key"></i> Change Password';
            
            // Clear password fields
            document.getElementById('current-password').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-new-password').value = '';
            
            // Reset validation
            resetPasswordValidationRules();
            document.getElementById('change-password-btn').disabled = true;
            document.getElementById('current-password-validation').textContent = '';
            document.getElementById('password-match-validation').textContent = '';
        }
    }

    function togglePasswordVisibility(input, button) {
        const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
        input.setAttribute('type', type);
        button.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
    }

    function showModal(type) {
        const modal = document.getElementById(`${type}-modal`);
        if (modal) {
            modal.classList.add('active');
        }
    }

    function hideModal(type) {
        const modal = document.getElementById(`${type}-modal`);
        if (modal) {
            modal.classList.remove('active');
        }
        
        // Clear delete confirmation password
        if (type === 'delete') {
            document.getElementById('confirm-password').value = '';
            document.getElementById('confirm-delete').disabled = true;
        }
    }

    function showLoading(text = 'Loading...') {
        const overlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        
        loadingText.textContent = text;
        overlay.classList.add('active');
    }

    function hideLoading() {
        const overlay = document.getElementById('loading-overlay');
        overlay.classList.remove('active');
    }

    function showToast(message, type = 'success') {
        // Remove existing toasts
        const existingToasts = document.querySelectorAll('.profile-toast');
        existingToasts.forEach(toast => toast.remove());
        
        // Create new toast
        const toast = document.createElement('div');
        toast.className = `profile-toast ${type}`;
        toast.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 
                               type === 'error' ? 'exclamation-circle' : 
                               type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
            <span>${message}</span>
        `;
        
        document.getElementById('toast-container').appendChild(toast);
        
        // Show toast
        setTimeout(() => {
            toast.classList.add('show');
        }, 10);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 300);
        }, 5000);
    }

    // Clean up on page unload
    window.addEventListener('beforeunload', () => {
        if (unsubscribeProfile) {
            unsubscribeProfile();
        }
        if (uploadTimeout) {
            clearTimeout(uploadTimeout);
        }
    });
</script>
</body>
</html>